# Quick Enumeration

| Command                                                                                                                                                                                                                                                             | Description                                                                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Get-NetDomain`                                                                                                                                                                                                                                                     | Basic domain info                                                                                                                                                                                                                                    |
| `Get-NetUser -UACFilter NOT_ACCOUNTDISABLE \| select samaccountname, description, pwdlastset, logoncount, badpwdcount`                                                                                                                                              | Basic user enabled info                                                                                                                                                                                                                              |
| `Get-NetUser -LDAPFilter '(sidHistory=*)'`                                                                                                                                                                                                                          | Find users with sidHistory set                                                                                                                                                                                                                       |
| `Get-NetUser -PreauthNotRequired`                                                                                                                                                                                                                                   | ASREPRoastable users                                                                                                                                                                                                                                 |
| `Get-NetUser -SPN`                                                                                                                                                                                                                                                  | Kerberoastable users                                                                                                                                                                                                                                 |
| `Get-NetGroup \| select samaccountname, admincount, description`                                                                                                                                                                                                    | Groups info                                                                                                                                                                                                                                          |
| `Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=EGOTISTICAL-BANK,DC=local' \| %{ $_.SecurityIdentifier } \| Convert-SidToName`                                                                                                                      | Get AdminSDHolders                                                                                                                                                                                                                                   |
| `Get-NetComputer \| select samaccountname, operatingsystem`                                                                                                                                                                                                         | Computers info                                                                                                                                                                                                                                       |
| `Get-NetComputer -Unconstrainusered \| select samaccountname`                                                                                                                                                                                                       | DCs always appear but aren't useful for privilege escalation **(Unconstrained)**                                                                                                                                                                     |
| `Get-NetComputer -TrustedToAuth \| select samaccountname`                                                                                                                                                                                                           | Find computers with Constrained Delegation                                                                                                                                                                                                           |
| `Get-DomainGroup -AdminCount \| Get-DomainGroupMember -Recurse \| ?{$_.MemberName -like '*$'}`                                                                                                                                                                      | Find any machine accounts in privileged groups                                                                                                                                                                                                       |
| `Find-DomainShare -CheckShareAccess`                                                                                                                                                                                                                                | Search readable shares                                                                                                                                                                                                                               |
| `Get-NetDomainTrus`                                                                                                                                                                                                                                                 | Get all domain trusts (parent, children and external)                                                                                                                                                                                                |
| `Get-NetForestDomain \| Get-NetDomainTrust`                                                                                                                                                                                                                         | Enumerate all the trusts of all the domains found                                                                                                                                                                                                    |
| `$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword \| % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} \| fl` | Check if any user passwords are set                                                                                                                                                                                                                  |
| `Find-LocalAdminAccess`                                                                                                                                                                                                                                             | Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.                                                                                                                            |
| `Invoke-UserHunter -CheckAccess`                                                                                                                                                                                                                                    | Get members from Domain Admins (default) and a list of computers and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host. If -Checkaccess, then it also check for LocalAdmin access in the hosts. |
| `Invoke-ACLScanner -ResolveGUIDs \| select IdentityReferenceName, ObjectDN, ActiveDirectoryRights \| fl`                                                                                                                                                            | Find interesting ACLs                                                                                                                                                                                                                                |

# Domain info


| Command                                                                           | Description                                                  |
| --------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| `Get-Domain`                                                                      | Get info about the current domain                            |
| `Get-NetDomain`                                                                   | Get info about the current domain                            |
| `Get-NetDomain -Domain mydomain.local`                                            | Get info about the current domain by domain *mydomain.local* |
| `Get-DomainSID`                                                                   | Get domain SID                                               |
| `Get-DomainPolicy`                                                                | Get info about the policy                                    |
| `(Get-DomainPolicy)."KerberosPolicy"`                                             | Kerberos tickets info(MaxServiceAge)                         |
| `(Get-DomainPolicy)."SystemAccess"`                                               | Password policy                                              |
| `Get-DomainPolicyData \| select -ExpandProperty SystemAccess`                     | Same as previous                                             |
| `(Get-DomainPolicy).PrivilegeRights`                                              | Check your privileges                                        |
| `Get-DomainPolicyData`                                                            | Same as Get-DomainPolicy                                     |
| `Get-DomainController \| select Forest, Domain, IPAddress, Name, OSVersion \| fl` | Get specific info of current domain controller               |
| `Get-NetDomainController -Domain mydomain.local`                                  | Get all ifo of specific domain Domain Controller             |
| `Get-ForestDomain`                                                                | Get Forest info                                              |

# Users, Groups, Computers & OUs


| Command                                                                                                                                                                           | Description                                                                                                                                                                                                      |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Get-DomainUser -Properties name, MemberOf \| fl`                                                                                                                                 | Get usernames and their groups                                                                                                                                                                                   |
| `Get-NetUser`                                                                                                                                                                     | Get users with several (not all) properties                                                                                                                                                                      |
| `Get-NetUser \| select samaccountname, description, pwdlastset, logoncount, badpwdcount`                                                                                          | List all usernames                                                                                                                                                                                               |
| `Get-NetUser -UserName student107`                                                                                                                                                | Get info about a user                                                                                                                                                                                            |
| `Get-NetUser -properties name, description`                                                                                                                                       | Get all descriptions                                                                                                                                                                                             |
| `Get-NetUser -properties name, pwdlastset, logoncount, badpwdcount`                                                                                                               | Get all pwdlastset, logoncount and badpwdcount                                                                                                                                                                   |
| `Find-UserField -SearchField Description -SearchTerm "built"`                                                                                                                     | Search account with "something" in a parameter                                                                                                                                                                   |
| `Get-DomainUser -Identity * \| ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} \|select samaccountname,useraccountcontrol`                                         | Get users with reversible encryption (PWD in clear text with dcsync)                                                                                                                                             |
| `Get-NetUser -UACFilter NOT_ACCOUNTDISABLE -properties distinguishedname`                                                                                                         | All enabled users                                                                                                                                                                                                |
| `Get-NetUser -UACFilter ACCOUNTDISABLE`                                                                                                                                           | All disabled users                                                                                                                                                                                               |
| `Get-NetUser -UACFilter SMARTCARD_REQUIRED`                                                                                                                                       | Users that require a smart card                                                                                                                                                                                  |
| `Get-NetUser -UACFilter NOT_SMARTCARD_REQUIRED -Properties samaccountname`                                                                                                        | Not smart card users                                                                                                                                                                                             |
| `Get-NetUser -LDAPFilter '(sidHistory=*)'`                                                                                                                                        | Find users with sidHistory set                                                                                                                                                                                   |
| `Get-NetUser -PreauthNotRequired`                                                                                                                                                 | ASREPRoastable users                                                                                                                                                                                             |
| `Get-NetUser -SPN \| select serviceprincipalname`                                                                                                                                 | Kerberoastable users                                                                                                                                                                                             |
| `Get-NetUser -SPN \| ?{$_.memberof -match 'Domain Admins'}`                                                                                                                       | Domain admins kerberostable                                                                                                                                                                                      |
| `Get-Netuser -TrustedToAuth \| select userprincipalname, name, msds-allowedtodelegateto`                                                                                          | Constrained Resource Delegation                                                                                                                                                                                  |
| `Get-NetUser -AllowDelegation -AdminCount`                                                                                                                                        | All privileged users that aren't marked as sensitive/not for delegation                                                                                                                                          |
| ```Get-ObjectAcl "dc=dev,dc=testlab,dc=local" -ResolveGUIDs \| ? {<br>    ($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')<br>}<br>``` | Retrieve *most* users who can perform DC replication for dev.testlab.local (i.e. DCsync)                                                                                                                         |
| `Get-DomainUser -UACFilter PASSWD_NOTREQD \| Select-Object samaccountname,useraccountcontrol`                                                                                     | - Users with PASSWD_NOTREQD set in the userAccountControl means that the user is not subject to the current password policy. - Users with this flag might have empty passwords (if allowed) or shorter passwords |
| `Get-DomainGroup \| where Name -like "*Admin*" \| select SamAccountName`                                                                                                          | Get Admin like groups                                                                                                                                                                                            |
| `Get-NetGroup`                                                                                                                                                                    | Get groups                                                                                                                                                                                                       |
| `Get-NetGroup -Domain mydomain.local`                                                                                                                                             | Get groups of an specific domain                                                                                                                                                                                 |
| `Get-NetGroup 'Domain Admins'`                                                                                                                                                    | Get all data of a group                                                                                                                                                                                          |
| `Get-NetGroup -AdminCount \| select name,memberof,admincount,member \| fl`                                                                                                        | Search admin grups                                                                                                                                                                                               |
| `Get-NetGroup -UserName "myusername`                                                                                                                                              | Get groups of a user                                                                                                                                                                                             |
| `Get-NetGroupMember -Identity "Administrators" -Recurse`                                                                                                                          | Get users inside "Administrators" group. If there are groups inside of this grup, the -Recurse option will print the users inside the others groups also                                                         |
| `Get-NetGroupMember -Identity "Enterprise Admins" -Domain mydomain.local`                                                                                                         | Remember that "Enterprise Admins" group only exists in the rootdomain of the forest                                                                                                                              |
| `Get-NetLocalGroup -ComputerName dc.mydomain.local -ListGroups`                                                                                                                   | Get Local groups of a machine (you need admin rights in no DC hosts)                                                                                                                                             |
| `Get-NetLocalGroupMember -computername dcorp-dc.dollarcorp.moneycorp.local`                                                                                                       | Get users of localgroups in computer                                                                                                                                                                             |
| `Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -ResolveGUIDs`                                                                                  | Check AdminSDHolder users                                                                                                                                                                                        |
| `Get-DomainObjectACL -ResolveGUIDs -Identity * \| ? {$_.SecurityIdentifier -eq $sid}`                                                                                             | Get ObjectACLs by sid                                                                                                                                                                                            |
| `Get-NetGPOGroup`                                                                                                                                                                 | Get restricted groups                                                                                                                                                                                            |
| `Get-DomainComputer -Properties DnsHostName`                                                                                                                                      | Get all domain maes of computers                                                                                                                                                                                 |
| `Get-NetComputer`                                                                                                                                                                 | Get all computer objects                                                                                                                                                                                         |
| `Get-NetComputer -Ping`                                                                                                                                                           | Send a ping to check if the computers are working                                                                                                                                                                |
| `Get-NetComputer -Unconstrained`                                                                                                                                                  | DCs always appear but aren't useful for privesc **(Unconstrained)**                                                                                                                                              |
| `Get-NetComputer -TrustedToAuth`                                                                                                                                                  | Find computers with Constrined Delegation                                                                                                                                                                        |
| `Get-DomainGroup -AdminCount \| Get-DomainGroupMember -Recurse \| ?{$_.MemberName -like '*$'}`                                                                                    | Find any machine accounts in privileged groups                                                                                                                                                                   |
| `Get-DomainOU -Properties Name \| sort -Property Name`                                                                                                                            | Get names of OUs                                                                                                                                                                                                 |
| `Get-DomainOU "Servers" \| %{Get-DomainComputer -SearchBase $_.distinguishedname -Properties Name}`                                                                               | Get all computers inside an OU (Servers in this case)                                                                                                                                                            |
| `Get-NetOU`                                                                                                                                                                       | Get Organization Units                                                                                                                                                                                           |
| `Get-NetOU StudentMachines \| %{Get-NetComputer -ADSPath $_}`                                                                                                                     | Get all computers inside an OU (StudentMachines in this case)                                                                                                                                                    |

# Logon and Sessions


| Command                                        | Description                                                                         |
| ---------------------------------------------- | ----------------------------------------------------------------------------------- |
| `Get-NetLoggedon -ComputerName <servername>`   | Get net logon users at the moment in a computer (need admins rights on target)      |
| `Get-NetSession -ComputerName <servername>`    | Get active sessions on the host                                                     |
| `Get-LoggedOnLocal -ComputerName <servername>` | Get locally logon users at the moment (need remote registry (default in server OS)) |
| `Get-LastLoggedon -ComputerName <servername>`  | Get last user logged on (needs admin rigths in host)                                |
| `Get-NetRDPSession -ComputerName <servername>` | List RDP sessions inside a host (needs admin rights in host)                        |

# Group Policy Object - GPOs

If an attacker has **high privileges over a GPO** he could be able to **privilege escalation** abusing it by **add permissions to a user**, **add a local admin user** to a host or **create a scheduled task** (immediate) to perform an action.


| Command                                                                                                                                                                                                                                                                                                               | Description                                                                                                  |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| `Get-DomainGPO \| select displayName`                                                                                                                                                                                                                                                                                 | Check the names for info                                                                                     |
| `Get-NetGPO`                                                                                                                                                                                                                                                                                                          | Get all policies with details                                                                                |
| `Get-NetGPO \| select displayname`                                                                                                                                                                                                                                                                                    | Get the names of the policies                                                                                |
| `Get-NetGPO -ComputerName <servername>`                                                                                                                                                                                                                                                                               | Get the policy applied in a computer                                                                         |
| `gpresult /V`                                                                                                                                                                                                                                                                                                         | Get current policy                                                                                           |
| `Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=invented,DC=io" -ResolveGUIDs \| ? { $_.ObjectAceType -eq "Group-Policy-Container" } \| select ObjectDN, ActiveDirectoryRights, SecurityIdentifier \| fl`                                                                                           | Get who can create new GPOs                                                                                  |
| `Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' \| ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty\|GenericAll\|GenericWrite\|WriteDacl\|WriteOwner')} \| select ObjectDN, ActiveDirectoryRights, SecurityIdentifier \| fl` | Enumerate permissions for GPOs where users with RIDs of > 1000 have some kind of modification/control rights |
| `$sid=Convert-NameToSid "Domain Users"`                                                                                                                                                                                                                                                                               | Get SID of a user or group                                                                                   |
| `Get-DomainGPO \| Get-ObjectAcl \| ?{$_.SecurityIdentifier -eq $sid}`                                                                                                                                                                                                                                                 | Get permissions a user/group has over any GPO                                                                |
| `Get-GPO -Guid 18E5A689-E67F-90B2-1953-198ED4A7F532`                                                                                                                                                                                                                                                                  | Convert GPO GUID to name                                                                                     |
| `ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126`                                                                                                                                                                                                                                                      | Transform SID to name                                                                                        |
| `Get-NetGPO -GPOName '{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}'`                                                                                                                                                                                                                                                        | Get GPO of an OU                                                                                             |
| `Get-DomainGPOLocalGroup \| select GPODisplayName, GroupName, GPOType`                                                                                                                                                                                                                                                | Returns all GPOs that modify local group memberships through Restricted Groups or Group Policy Preferences.  |
| `Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators \| select ObjectName, GPODisplayName, ContainerName, ComputerName`                                                                                                                                                                                     | Enumerates the machines where a specific domain user/group is a member of a specific local group.            |

# ACL


| Command                                                                                                                                                                                                                | Description                                                                                                               |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| `Get-ObjectAcl -SamAccountName <username> -ResolveGUIDs`                                                                                                                                                               | Get ACLs of an object (permissions of other objects over the indicated one)                                               |
| `Get-DomainObjectACL -ResolveGUIDs -Identity * \| ? {$_.SecurityIdentifier -eq $sid}`                                                                                                                                  | Other way to get ACLs of an object                                                                                        |
| `Get-PathAcl -Path "\\dc.mydomain.local\sysvol"`                                                                                                                                                                       | Get permissions of a file                                                                                                 |
| `Find-InterestingDomainAcl -ResolveGUIDs`                                                                                                                                                                              | Find intresting ACEs (Interesting permisions of "unexpected objects" (RID>1000 and modify permissions) over other objects |
| `Find-InterestingDomainAcl -ResolveGUIDs \| ?{$_.IdentityReference -match "RDPUsers"}`                                                                                                                                 | Check if any of the interesting permissions founds is realated to a username/group                                        |
| `Get-NetGroupMember -GroupName "Administrators" -Recurse \| ?{$_.IsGroup -match "false"} \| %{Get-ObjectACL -SamAccountName $_.MemberName -ResolveGUIDs} \| select ObjectDN, IdentityReference, ActiveDirectoryRights` | Get special rights over All administrators in domain                                                                      |

# Shared files and folders


| Command                              | Description                                                                |
| ------------------------------------ | -------------------------------------------------------------------------- |
| `Get-NetFileServer`                  | Search file servers. Lot of users use to be logged in this kind of servers |
| `Find-DomainShare -CheckShareAccess` | Search readable shares                                                     |
| `Find-InterestingDomainShareFile`    | Find interesting files, can use filters                                    |

# Domain Trust


| Command                                                    | Description                                                                                                |
| ---------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| `Get-NetDomainTrust`                                       | Get all domain trusts (parent, children and external)                                                      |
| `Get-DomainTrust`                                          | Same                                                                                                       |
| `Get-NetForestDomain \| Get-NetDomainTrust`                | Enumerate all the trusts of all the domains found                                                          |
| `Get-DomainTrustMapping`                                   | Enumerate also all the trusts                                                                              |
| `Get-ForestDomain`                                         | Get basic forest info                                                                                      |
| `Get-ForestGlobalCatalog`                                  | Get info of current forest (no external)                                                                   |
| `Get-ForestGlobalCatalog -Forest external.domain`          | Get info about the external forest (if possible)                                                           |
| `Get-DomainTrust -SearchBase "GC://$($ENV:USERDNSDOMAIN)"` | Retrieve information about trust relationships established between domains in an Active Directory forest   |
| `Get-NetForestTrust`                                       | Get forest trusts (it must be between 2 roots, trust between a child and a root is just an external trust) |
| `Get-DomainForeingUser`                                    | Get users with privileges in other domains inside the forest                                               |
| `Get-DomainForeignGroupMember`                             | Get groups with privileges in other domains inside the forest                                              |

# L**ow**-**hanging fruit**


| Command                                                                                                                                                                                                                                                             | Description                                                                                                                                                                                                           |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword \| % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} \| fl` | Check if any user passwords are set                                                                                                                                                                                   |
| `Find-LocalAdminAccess`                                                                                                                                                                                                                                             | Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.                                                                                             |
| `.\Find-WMILocalAdminAccess.ps1 -ComputerFile .\computers.txt`                                                                                                                                                                                                      | (This time you need to give the list of computers in the domain) Do the same as before but trying to execute a WMI action in each computer (admin privs are needed to do so). Useful if RCP and SMB ports are closed. |
| `Get-DomainGPOUserLocalGroupMapping -Identity <User/Group>`                                                                                                                                                                                                         | Enumerate machines where a particular user/group identity has local admin rights                                                                                                                                      |
| `Invoke-EnumerateLocalAdmin`                                                                                                                                                                                                                                        | Enumerates the members of specified local group (default administrators)                                                                                                                                              |
| `Find-DomainLocalGroupMember`                                                                                                                                                                                                                                       | For all the targeted machines on the current (or specified) domain.                                                                                                                                                   |
| `Find-DomainUserLocation -ComputerUnconstrained -ShowAll`                                                                                                                                                                                                           | Search unconstrained delegation computers and show usersonstrained delegation computers and show users                                                                                                                |
| `Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation`                                                                                                                                                                               | Admin users that allow delegation, logged into servers that allow unconstrained delegation                                                                                                                            |
| `Find-DomainUserLocation [-CheckAccess] \| select UserName, SessionFromName`                                                                                                                                                                                        | Get members from Domain Admins (default) and a list of computers, and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host.                                         |
| `Invoke-UserHunter [-CheckAccess]`                                                                                                                                                                                                                                  | Same as previous one                                                                                                                                                                                                  |
| `Invoke-UserHunter -GroupName "RDPUsers"`                                                                                                                                                                                                                           | Search "RDPUsers" users                                                                                                                                                                                               |
| `Invoke-UserHunter -Stealth`                                                                                                                                                                                                                                        | Search for active users inside high traffic servers (DC, File Servers and Distributed File servers)                                                                                                                   |

# MISC


| Command                                                                                                                                                                                                                          | Description                                                                         |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| `Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *`                                                                                                                                                | You need to be in the AD Recycle Bin group of the AD to list the deleted AD objects |
| `"S-1-5-21-1874506631-3219952063-538504511-2136" \| Convert-SidToName`                                                                                                                                                           | SID to Name                                                                         |
| `Invoke-Kerberoast [-Identity websvc]`                                                                                                                                                                                           | Without "-Identity" kerberoast all possible users                                   |
| ```<br>$SecPassword = ConvertTo-SecureString 'BurgerBurgerBurger!' -AsPlainText -Force<br>$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)<br>Get-DomainUser -Credential $Cred<br>``` | Use an alterate creadential for any function                                        |

